<!DOCTYPE html>
<html>
<head>
  <title>Payment Apps and Browsers</title>
    <meta charset='utf-8'>
    <script src='https://www.w3.org/Tools/respec/respec-w3c-common'
            async class='remove'>
    </script>
    <script class='remove'>
        var respecConfig = {
            shortName:  "payment-apps-browser",
            edDraftURI:   "https://w3c.github.io/webpayments/proposals/paymentapps/payment-apps.html",
            specStatus: "unofficial",
            editors: [
                {   name:       "Adrian Hope-Bailie",
                    url:        "https://github.com/adrianhopebailie",
                    company:    "Ripple",
                    companyURL: "https://ripple.com"
                },
                {   name:       "Tommy Thorsen",
                    url:        "https://github.com/tommythorsen",
                    company:    "Opera",
                    companyURL: "https://opera.com"
                },
                {   name:       "Adam Roach",
                    url:        "https://github.com/adamroach",
                    company:    "Mozilla",
                    companyURL: "https://mozilla.org"
                },
                {   name:       "Jason Normore",
                    url:        "https://github.com/jnormore",
                    company:    "Shopify",
                    companyURL: "https://shopify.com"
                },
            ],

            useExperimentalStyles: true,
            license:      "w3c-software-doc",

            wg:           "Web Payments Working Group",
            wgURI:        "https://www.w3.org/Payments/WG/",
            wgPublicList: "public-payments-wg",
            wgPatentURI:  "https://www.w3.org/2004/01/pp-impl/83744/status",

            issueBase:    "https://github.com/w3c/webpayments/issues/",

            localBiblio:  {
                "PAYMENT-REQUEST-API": {
                    title:    "Payment Request API",
                    href:     "http://www.w3.org/TR/payment-request/",
                    authors:  [
                        "Adrian Bateman",
                        "Zach Koch",
                        "Roy McElmurray"
                    ],
                    status:   "FPWD"
                },
                "PAYMENT-ARCH": {
                    title:    "A Role-based Architecture for Processing Payment Requests",
                    href:     "https://w3c.github.io/webpayments/proposals/architecture/",
                    authors:  [
                        "Adrian Hope-Bailie"
                    ],
                    status:   "unofficial"
                },
                "METHOD-IDENTIFIERS": {
                    title:    "Payment Method Identifiers",
                    href:     "https://www.w3.org/TR/payment-method-id/",
                    authors:  [
                        "Adrian Bateman",
                        "Zach Koch",
                        "Roy McElmurry"
                    ],
                    status:   "FPWD"
                }
            }
        };
    </script>
    <style>
        dt { margin-top: 0.75em; }
        table { margin-top: 0.75em; border-collapse:collapse; border-style:hidden hidden none hidden }
        table thead { border-bottom:solid }
        table tbody th:first-child { border-left:solid }
        table td, table th { border-left:solid; border-right:solid; border-bottom:solid thin; vertical-align:top; padding:0.2em }
        li { margin-top: 0.5em; margin-bottom: 0.5em;}
    </style>
</head>
<body>
<section id='abstract'>
  <p>The Payment Request API [[!PAYMENT-REQUEST-API]] provides
    a standard way to initiate payment requests from Web pages and
    applications. Browsers implementing that API prompt the user
    to select a payment method and authorize payment, after which
    the browser returns a payment response to the originating site.
    The current specification adds <strong>payment apps</strong>
    to this user experience. It defines how users
    register payment apps with browsers, how browsers support the display of matching payment apps and selection by the user, and how communication takes
    place between browsers and selected payment apps to fulfill the requirements of the underlying Payment Request API.</p>
</section>
<section id='sotd'>
    <p>The Web Payments Working Group maintains <a href=
                                              "https://github.com/w3c/webpayments/issues?q=is%3Aissue+is%3Aopen+label%3A%22Proposal%3A+Payment+Apps%22">
        a list of all bug reports that the group has not yet addressed</a>.
        This draft highlights some of the pending issues that are still to
        be discussed in the working group. No decision has been taken on
        the outcome of these issues including whether they are valid. Pull
        requests with proposed specification text for outstanding issues
        are strongly encouraged.</p>
</section>
<section class='informative'>
  <h2>Introduction</h2>

  <p>The Web Payments Working Group seeks to streamline checkout to
  help reduce "shopping cart abandonment" and make it easier to use
  new payment methods on the Web. It has published the Payment Request
  API [[!PAYMENT-REQUEST-API]] as a standard way to initiate payment
  requests from Web pages and applications. This specification adds
  payment apps to the experience. It
  defines:<p>

    <ul>
      <li>How users register and unregister payment apps with the browser, and how browsers learn when the user updates a payment app.</li>
      <li>How the browser matches payment methods supported by the payee with those available in registered payment apps.</li>
      <li>How the browser displays matching payment apps to the user for selection to make a payment.</li>
      <li>How the browser invokes a selected payment app, communicates input/response data with it, and returns the response data to the underlying Payment Request API.</li>
    </ul>


  <p>Payment apps may be implemented in a variety of ways: as in-browser applications, native operating system applications, browser extensions, built-in browser components, interface-less Web services, or a combination. This specification does not cover every aspect of communication on every platform.</p>

  <p><strong>Note:</strong> The Web Payments Working Group has used the term "mediator" to refer to the software (here, the browser) that carries out the activities defined in this specification (matching, display, etc.).</p>
</section>
<section id='conformance'>
  <p>Most of the requirements in this specification are for Web browsers (or any other user agent). Some requirements and good practices are for payment apps.</p>
</section>
<section id="dependencies">
  <h3>Dependencies</h3>
  <p>This specification relies on several other underlying specifications.</p>
    <dl>
          <dt>Payment Request Architecture</dt>
          <dd>The term <dfn data-lt="payment method|payment methods">Payment Method</dfn>
	    is defined by the Payment Request Architecture document
        [[PAYMENT-ARCH]].</dd>
        <dt>Payment Request API</dt>
        <dd>The terms <dfn>Payment Request API</dfn>,
            <dfn>PaymentRequest</dfn> and <dfn>PaymentResponse</dfn> are defined by the
            Payment Request API specification [[!PAYMENT-REQUEST-API]].</dd>
        <dt>Payment Method Identifiers</dt>
        <dd>The term <dfn data-lt=
                                  "payment method identifier|payment method identifiers">payment
            method identifier</dfn> is defined by the Payment Method
            Identifiers specification [[!METHOD-IDENTIFIERS]].</dd>
	<!--
        <dt>HTML5</dt>
        <dd>The terms <dfn>global object</dfn>, <dfn>queue a task</dfn>,
            <dfn>browsing context</dfn>, and <dfn>top-level browsing
                context</dfn> are defined by [[!HTML5]].</dd>
        <dt>ECMA-262 6th Edition, The ECMAScript 2015 Language
            Specification</dt>
        <dd>The terms <dfn>Promise</dfn>, <dfn>internal slot</dfn>,
            <dfn><code>TypeError</code></dfn>, <dfn>JSON.stringify</dfn>,
            <dfn>JSON.parse</dfn>, <dfn><code>Array</code></dfn>,
            <dfn><code>type</code></dfn> and the <dfn>[[\GetOwnProperty]]</dfn>
            operation are defined by [[!ECMA-262-2015]].
            <p>This document uses the format <em>object</em>@[[\slotname]] to
                mean the internal slot [[\slotname]] of the object
                <em>object</em>.</p>
            <p>The term <dfn>JSON-serializable object</dfn> used in this
                specification means an object that can be serialized to a string
                using <a>JSON.stringify</a> and later deserialized back to an
                object using <a>JSON.parse</a> with no loss of data.</p>
            <p>When instructed to <dfn>Trim</dfn>(<var>x</var>), a user agent
                MUST behave as if [[!ECMA-262-2015]]'s
                <code>String.prototype.trim()</code> function had been called on
                the string <var>x</var>.</p>
        </dd>
        <dt>DOM4</dt>
        <dd>The <code><dfn>Event</dfn></code> type and the terms <dfn>fire
            an event</dfn>, <dfn>dispatch flag</dfn>, <dfn>stop propagation
            flag</dfn>, and <dfn>stop immediate propagation flag</dfn> are
            defined by [[!DOM4]].
            <p><dfn>DOMException</dfn> and the following DOMException types
                from [[!DOM4]] are used:</p>
            <table>
                <tr>
                    <th>Type</th>
                    <th>Message (optional)</th>
                </tr>
                <tr>
                    <td><code><dfn>InvalidStateError</dfn></code></td>
                    <td>The object is in an invalid state</td>
                </tr>
                <tr>
                    <td><code><dfn>NotSupportedError</dfn></code></td>
                    <td>The payment method was not supported</td>
                </tr>
                <tr>
                    <td><code><dfn>SecurityError</dfn></code></td>
                    <td>The operation is only supported in a secure context</td>
                </tr>
            </table>
        </dd>
        <dt>WebIDL</dt>
        <dd>When this specification says to <dfn>throw</dfn> an error, the
            <a>user agent</a> must throw an error as described in [[!WEBIDL]].
            When this occurs in a sub-algorithm, this results in termination of
            execution of the sub-algorithm and all ancestor algorithms until
            one is reached that explicitly describes procedures for catching
            exceptions.</dd>
	-->
        <dt>Secure Contexts</dt>
        <dd>The term <dfn>secure context</dfn> is defined by the Secure
          Contexts specification [[!POWERFUL-FEATURES]].</dd>
	<!--
        <dt>URL</dt>
        <dd>The <dfn>URL</dfn> concept and <dfn>URL parser</dfn> are
            defined in [[!WHATWG-URL]].</dd>
        <dt>Fetch</dt>
        <dd>The terms <dfn>Fetch</dfn>, <dfn>Request</dfn>, <dfn data-lt="body">Request Body</dfn>, <dfn data-lt="method">Request
            Method</dfn>, <dfn>Header List</dfn>, <dfn>Response</dfn>,
            <dfn>Context</dfn> and <dfn>Network Error</dfn> are defined in
            [[!FETCH]].</dd>
	-->
        <dt>Service Workers</dt>
        <dd>The term <dfn data-lt="service worker|service workers">service worker</dfn> is defined in
        [[SERVICE-WORKERS]].</dd>
    </dl>
</section>
<section>
  <h2>Definitions</h2>
  <h3>Payment App Implementation Technology</h3>
  <dl>
    <dt><dfn id="">browser-based payment app</dfn></dt>
    <dd>a payment app that runs in a browser.</dd>
    <dt><dfn id="">headless Web payment app</dfn></dt>
    <dd>a payment app that has no user interface but communicates using Web technology (such as HTTP).</dd>
    <dt><dfn id="">web-based payment app</dfn></dt>
    <dd>a browser-based or headless Web payment app.</dd>
    <dt><dfn id="">native payment app</dfn></dt>
    <dd>a payment app built with the operating system default technology stack that uses non-Web technologies.</dd>
  </dl>
  <h3>Payment Method Support</h3>
  <dl>
    <dt><dfn id="">supported payment method</dfn></dt>
    <dd>a payment method that a user may configure a payment app to use, but for which the user has not provided data.</dd>
    <dt><dfn id="">unsupported payment method</dfn></dt>
    <dd>a payment method that a user cannot configure a payment app to use. Note that updates to a payment app may cause an unsupported payment method to becomes supported.</dd>
    <dt><dfn id="">enabled payment method </dfn></dt>
    <dd>a payment method that a user has configured a payment app to use.</dd>
    <dt><dfn id="">enabled payment instrument</dfn></dt>
    <dd>the data that the user has provided when configuring the payment app; the nature of the data depends on the payment method (e.g., for legacy card payments, a card number and expiration date).
  </dl>
  
  <h3>Payment App Status</h3>
  <dl>
    <dt><dfn id="">registered payment app</dfn></dt>
    <dd>a payment app that is "known" to the browser for the purposes of the interactions described in this document.</dd>
    <dt><dfn id="">unregistered payment app</dfn></dt>
    <dd>a payment app that is unknown to the browser, either because it has never been registered, or because it has been unregistered.</dd>
    <dt><dfn id="">enabled payment app</dfn></dt>
    <dd>a registered payment app with at least one enabled payment method.</dd>
    <dt><dfn id="">ignored payment app</dfn></dt>
    <dd>a payment app that, per user configuration, the user agent does included in matching computations and does not invoke for payment. A payment app may be ignored for some transactions and not for others.</dd>
    <dt><dfn id="">recommended payment app</dfn></dt>
    <dd>a payment app identified by the payee or browser that may be enabled, or just registered, or unregistered.</dd>
    <dt><dfn id="">matching payment app</dfn></dt>
    <dd>a non-ignored payment app that is either enabled with one enabled payment method accepted by the payee, or recommended with one supported payment method accepted by the payee.</dd>
    <dt><dfn id="">displayed payment app</dfn></dt>
    <dd>a matching payment app displayed by the browser for user selection but not yet selected. <strong>Note:</strong> Payment apps may be displayed in a variety of modalities, including visual and aural.</dd>
    <dt><dfn id="">selected payment app</dfn></dt>
    <dd>after display, the app selected by the user to make a payment, but not yet invoked.</dd>
    <dt><dfn id="">invoked payment app</dfn></dt>
    <dd>the selected payment app that the browser has invoked (executed) and passed payment app input data.</dd>
  </dl>
  <h3>Payment App Invocation and Response Data</h3>
    <dl>
    <dt><dfn id="">selected payment instrument</dfn></dt>
    <dd>the payment instrument selected by the user within the payment app to make a payment.</dd>
    <dt><dfn id="">payment app invocation data</dfn></dt>
    <dd>Data provided to the invoked payment app by the browser. This data is a subset of data input to the Payment Request API.</dd>
    <dt><dfn id="">payment app response data</dfn></dt>
    <dd>Data provided by an invoked payment app to the browser, typically after payment authorization or other action taken through the payment app. This data, which will vary according to payment method, is then passed through the Payment Request API as the payment response.</dd>
  </dl>
</section>
<section>
  <h2>Payment App Registration, Updates, and Unregistration</h2>
  <section>
    <h3>Registration</h3>
    <ul>
      <li>Note: Users register payment apps. But the code for registration is written by the publishers of those payments apps.</li>
      <li>Todo: Define registration in terms of a service worker.</li>
      <li>Data:
	<ul>
	  <li>Todo: Information sufficient to create a service worker.</li>
	  <li>Supported payment methods</li>
	  <li>Enabled payment methods</li>
	  <li>Information necessary to invoke the app (e.g., JS blob)</li>
	  <li><strong>Question</strong>. Should the registration data also include details about payment instruments? This would allow the browser to display more detail and facilitate selection. The details might not be "all the information" but enough (e.g., "last four digits of the card") to guide user selection. The browser might also use this information to improve per-instrument pricing.</li>
	  <li><strong>Question</strong>: What, if anything, should we say about registering native payment apps? Should we publish separate "good practices" documents for different platforms?</li>
	</ul>
  </section>
  <section>
    <h3>Updates</h3>
    <ul>
      <li>Todo: Define udpates in terms of a service worker.</li>
    </ul>
  </section>
  <section>
    <h3>Unregistration</h3>
    <ul>
      <li>The browser <span class='rfc2119'>MUST</span> enable a user to unregister a payment app.</li>
      <li>Todo: Define unregistration in terms of a service worker.</li>
    </ul>
  </section>
</section>
<section>
  <h2>Payment App Matching</h2>
  <ul>
    <li>Dependency: The matching algorithm that will be defined in the payment method identifier specification.</li>
    <li>Todo: Define how the browser invokes that algorithm with payment method information from paymentRequest API and the aggregation of:
      <ul>
	<li>enabled payment methods across all registered payment apps.</li>
	<li>supported payment methods of recommended but unregistered payment apps</li>
      </ul>
    </li>
  </ul>
</section>
<section>
  <h2>Payment App Display and User Selection</h2>
  <section>
    <h3>Display</h3>
    <ul>
      <li>The browser <span class='rfc2119'>MUST</span> display all matching payment apps.</li>
      <li>The browser <span class='rfc2119'>MAY</span> display recommended payment apps.</li>
      <li>In its display, the browser <span class='rfc2119'>MUST</span> distinguish recommended payment apps from other payment apps.</li>
      <li>The browser <span class='rfc2119'>MAY</span> allow the user to configure the display of matching payment apps.</li>
      <li>The browser <span class='rfc2119'>MUST</span> display matching payment apps in an order that corresponds to the order of supported payment methods supplied by the payee, except where the browser enables the user to override this order.</li>
      <li>The browser <span class='rfc2119'>SHOULD</span> display any payee-recommended apps in the order specified by the payee.</li>
    </ul>

    <section>
      <h4>Browser Display Examples</h4>
      <p><em>This section is informative.</em></p>
      <p>The following are examples browser display behavior.</p>
      <ul>
	<li>Display a user-configured preferred payment app at the top of a list of matching payment apps.</li>
	<li>Enable the user to set a default payment app for a Web site, and display that payment at the top of a list of matching payment apps for transactions with that site.</li>
	<li>Enable the user to set a default payment app for a Web site (e.g., the payment app distributed by that retailer), and display that payment at the top of a list of matching payment apps for transactions with that site.</li>
      </ul>
    </section>
  </section>
  <section>
    <h3>User Selection</h3>
    <ul>
      <li>The user agent  <span class='rfc2119'>MUST</span> enable the user to select any displayed payment app.</li>
      <li>If the user selects an unregistered recommended payment app, the browser <span class='rfc2119'>SHOULD</span> offer the user an opportunity to register it.</li>
    </ul>
  </section>
</section>
<section>
  <h2>Payment App Invocation and Response</h2>
  <section>
    <h3>Payment App Invocation</h3>
    <ul>
      <li>Todo: Define invocation as an event that causes the registered service worker to launch the payment app and pass it input data.</li>
      <li>Todo: define the algorithm that creates the payment app invocation data: Let P be the intersection of payment methods supported by the payee and enabled by the selected app. Send the data corresponding to P, as well as any global transaction data (total, etc.) to the payment app.</li>
      <li>Web-based payment apps  <span class='rfc2119'>MUST</span> run in a secure context.</li>
      <li><strong>Question</strong>: What, if anything, should we say about launching native payment apps? Should we publish separate "good practices" documents for different platforms?</li>
    </ul>
  </section>
  <section>
    <h3>Payment App Response Response</h3>
    <ul>
      <li>Todo: Define response in terms of an event that causes the registered service worker to wake up when the payment app has completed, passing the payment app response data back to the paymentRequestAPI.</li>
      <li>The user agent <span class='rfc2119'>MUST</span> return the payment app response data to the Payment Request API at step 1 of the "user accepts the payment request algorithm."</li>
    </ul>
  </section>
</section>
<section>
  <h2>Security and Privacy Considerations</h2>
  <section>
    <h3>Design Considerations</h3>
    <ul>
      <li>The API does not share information about the user's registered payment methods or payment apps with the payee. The only information that is shared is the result of user selection of a payment instrument.</li>
    </ul>
  </section>
  <section>
    <h3>Secure Communications</h3>
    <ul>
      <li>See <a href="https://www.w3.org/TR/service-workers/#security-considerations">Service Worker security considerations</a></li>
      <li>Payment method security is outside the scope of this specification and is addressed by payment apps that support those payment methods.</li>
    </ul>
  </section>
  <section>
    <h3>Data Validation</h3>
    <ul>
      <li>Payees should validate that the data they have received through the paymentRequest API is what they expect (e.g., the total that was paid, etc.).</li>
    </ul>
  </section>
</section>
</body>
</html>
