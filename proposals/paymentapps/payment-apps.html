<!DOCTYPE html>
<html>
<head>
    <title>Interoperability between Payment Apps and User
        Agents</title>
    <meta charset='utf-8'>
    <script src='https://www.w3.org/Tools/respec/respec-w3c-common'
            async class='remove'>
    </script>
    <script class='remove'>
        var respecConfig = {
            shortName:  "payment-apps-browser",
            edDraftURI:   "https://w3c.github.io/webpayments/proposals/paymentapps/payment-apps.html",
            specStatus: "unofficial",
            editors: [
                {   name:       "Adrian Hope-Bailie",
                    url:        "https://github.com/adrianhopebailie",
                    company:    "Ripple",
                    companyURL: "https://ripple.com"
                },
                {   name:       "Tommy Thorsten",
                    url:        "",
                    company:    "Opera",
                    companyURL: "https://opera.com"
                },
                {   name:       "Adam Roach",
                    url:        "",
                    company:    "Mozilla",
                    companyURL: "https://mozilla.org"
                },
                {   name:       "Jason Normore",
                    url:        "",
                    company:    "Shopify",
                    companyURL: "https://shopify.com"
                },
            ],

            useExperimentalStyles: true,
            license:      "w3c-software-doc",

            wg:           "Web Payments Working Group",
            wgURI:        "https://www.w3.org/Payments/WG/",
            wgPublicList: "public-payments-wg",
            wgPatentURI:  "https://www.w3.org/2004/01/pp-impl/83744/status",

            issueBase:    "https://github.com/w3c/webpayments/issues/",

            localBiblio:  {
                "PAYMENT-REQUEST-API": {
                    title:    "Payment Request API",
                    href:     "http://www.w3.org/TR/payment-request/",
                    authors:  [
                        "Adrian Bateman",
                        "Zach Koch",
                        "Roy McElmurray"
                    ],
                    status:   "FPWD"
                },
                "PAYMENT-ARCH": {
                    title:    "A Role-based Architecture for Processing Payment Requests",
                    href:     "https://w3c.github.io/webpayments/proposals/architecture/",
                    authors:  [
                        "Adrian Hope-Bailie"
                    ],
                    status:   "unofficial"
                },
                "METHOD-IDENTIFIERS": {
                    title:    "Payment Method Identifiers",
                    href:     "https://www.w3.org/TR/payment-method-id/",
                    authors:  [
                        "Adrian Bateman",
                        "Zach Koch",
                        "Roy McElmurry"
                    ],
                    status:   "FPWD"
                }
            }
        };
    </script>
    <style>
        dt { margin-top: 0.75em; }
        table { margin-top: 0.75em; border-collapse:collapse; border-style:hidden hidden none hidden }
        table thead { border-bottom:solid }
        table tbody th:first-child { border-left:solid }
        table td, table th { border-left:solid; border-right:solid; border-bottom:solid thin; vertical-align:top; padding:0.2em }
        li { margin-top: 0.5em; margin-bottom: 0.5em;}
    </style>
</head>
<body>
<section id='abstract'>
    <p>This specification describes how <a>payment apps</a> can be
        registered with a <a>user agent</a> and how the <a>user agent</a>
        interfaces with <a>payment apps</a> to initate the processing of a
        payment request and get back a payment response.</p>
</section>
<section id='sotd'>
    <p>The working group maintains <a href=
                                              "https://github.com/w3c/webpayments/issues?q=is%3Aissue+is%3Aopen+label%3A%22Proposal%3A+Payment+Apps%22">
        a list of all bug reports that the group has not yet addressed</a>.
        This draft highlights some of the pending issues that are still to
        be discussed in the working group. No decision has been taken on
        the outcome of these issues including whether they are valid. Pull
        requests with proposed specification text for outstanding issues
        are strongly encouraged.</p>
</section>
<section class='informative'>
    <h2>Introduction</h2>
    <div class="issue" title=
            "Should this document be combined with the Payment Request API specification?">
        <p>
            The majority of the following text gives context to this specification in relation
            to the Payment Request API specification. It repeats a lot of information that is
            already captured in other specifications suggesting the two should be combined.
        </p>

        <p>
            Also, since the requirements for registration and interoperability of payment apps with user agents
            is currently described in this document and the processing of payment requests by the API is
            described in another document neither document can exist in isolation.
        </p>
        <p>
            Therefor it may make sense to either:
        <ol>
            <li>Combine the two documents</li>
            <li>Establish some normative relationship between them</li>
        </ol>
        </p>
    </div>
    <p>The Payment Request API [[!PAYMENT-REQUEST-API]] defines an API
        for websites to initiate payment requests in a <a>user
            agent</a>. These payment requests are then passed to a
        <a>payment app</a> for processing.</p>
    <p>The <a>payment app</a> is an application that is registered by
        the payer with the <a>user agent</a>. <a>Payment apps</a> support
        one or more <a>payment methods</a> for processing payment requests.</p>
    <p>The Payment Request API specification
        describes how the <a>user agent</a>, acting as a mediator between
        the payee website and the payer, assists the user in selecting a
        <a>payment app</a> that can process the payment request it has received
        from the website. This implies that the selected <a>payment app</a>
        will support at least one of the <a>payment methods</a> that is also
        supported by the payee.</p>
    <p>This specification describes:</p>
    <ul>
        <li>How payment app publishers register <a>payment apps</a> with
            the <a>user agent</a>.</li>
        <li>How, after the user selects a payment app to use, the payment
            request is passed to the <a>payment app</a>.</li>
        <li>How a payment response is then returned by the app to the
            <a>user agent</a>?</li>
    </ul>
    <p>The API described in this document forms part of the payment
        request processing system described in the Architecture for Processing
        Payment Requests [[!PAYMENT-ARCH]].</p>
    <section id="goals">
        <h2>Goals</h2>
        <ul>
            <li>Allow users to register <a>payment apps</a> with their user
                agent such that the user agent is able to maintain a registry of
                the <a>payment methods</a> that are enabled by the app.</li>
            <li>Allow <a>payment apps</a> to update the set of <a>payment
                methods</a> that they have enabled.</li>
            <li>Standardize a platform-independant mechanism for a <a>user
                agent</a> to pass a payment request to a <a>payment app</a>.</li>
            <li>Support <a>payment apps</a>, with or without a user interface,
                on any web-accessible platform.</li>
        </ul>
    </section>
    <section id="non-goals">
        <h2>Non-goals</h2>
        <p>This specification does not attempt to define the full set of
            interfaces between the <a>user agent</a> and <a>payment apps</a>
            as it is anticipated that <a>payment apps</a>
            will be implemented on a variety of platforms and that the
            interfaces between the <a>user agent</a> and apps on platforms
            other than the Web will be implementation specific.</p>
    </section>
</section>
<section id='conformance'>
    <div class="issue" data-number="" title=
            "What are the appropriate conformance criteria for user agents and apps?">
        <p>This specification describes a mechanism that all user agents
            MUST support in order to allow for third party payment apps to be
            published and used from that user agent, however user agents may
            also have built in payment apps or allow other types of payment app
            such as browser extensions. How the integration works for these is
            implementation specific so we need to word the conformance criteria
            appropriately.</p>
    </div>
    <p>This specification defines one class of products:</p>
    <dl>
        <dt><dfn>Conforming user agent</dfn></dt>
        <dd>
            <p>A <dfn data-lt="user agents">user agent</dfn> MUST behave as
                described in this specification in order to be considered
                conformant. In this specification, <a>user agent</a> means a
                <em>Web browser or other interactive user agent</em> as defined in
                [[!HTML5]].</p>
            <p>User agents MAY implement algorithms given in this specification
                in any way desired, so long as the end result is indistinguishable
                from the result that would be obtained by the specification's
                algorithms.</p>
            <p>A conforming user agent MUST also be a <em>conforming
                implementation</em> of the IDL fragments of this specification, as
                described in the “Web IDL” specification. [[!WEBIDL]]</p>
            <aside class="note">This specification uses both the terms
                "conforming user agent(s)" and "user agent(s)" to refer to this
                product class.</aside>
        </dd>
    </dl>
</section>
<section id="dependencies">
    <h3>Dependencies</h3>
    <p>This specification relies on several other underlying
        specifications.</p>
    <dl>
        <dt>Architecture for Processing Payment Requests</dt>
        <dd>The terms <dfn data-lt="payment method|payment methods">payment
            method</dfn>, <dfn>payment method data</dfn> and <dfn>payment
            method specification</dfn> are defined in the Architecture
            for Processing Payment Requests [[!PAYMENT-ARCH]].</dd>
        <dt>Payment Request API</dt>
        <dd>The terms <dfn>Payment Request API</dfn>,
            <dfn>PaymentRequest</dfn> and <dfn>PaymentResponse</dfn> and the
            methods <dfn>PaymentRequest.show</dfn> and
            <dfn>PaymentRequest.complete</dfn> are defined by the
            Payment Request API specification [[!PAYMENT-REQUEST-API]].</dd>
        <dt>Payment Method Identifiers</dt>
        <dd>The term <dfn data-lt=
                                  "payment method identifier|payment method identifiers">payment
            method identifier</dfn> is defined by the Payment Method
            Identifiers specification [[!METHOD-IDENTIFIERS]].</dd>
        <!--
        <dt>Web App Manifest</dt>
        <dd>The terms <dfn>manifest</dfn>, <dfn data-lt=
                                                        "installed|installing|installable application">installed
            application</dfn>, <dfn>name</dfn>, <dfn>application context</dfn>,
            <dfn data-lt="related application|related_applications">related
                application</dfn>, <dfn>extension point</dfn> and the processes
            <dfn data-lt="apply">apply a manifest</dfn>, <dfn>issue a developer
                warning</dfn>, <dfn>steps for processing a manifest</dfn> and
            <dfn>steps for obtaining a manifest</dfn> are defined by
            [[!APPMANIFEST]].</dd>
        -->
        <dt>HTML5</dt>
        <dd>The terms <dfn>global object</dfn>, <dfn>queue a task</dfn>,
            <dfn>browsing context</dfn>, and <dfn>top-level browsing
                context</dfn> are defined by [[!HTML5]].</dd>
        <dt>ECMA-262 6th Edition, The ECMAScript 2015 Language
            Specification</dt>
        <dd>The terms <dfn>Promise</dfn>, <dfn>internal slot</dfn>,
            <dfn><code>TypeError</code></dfn>, <dfn>JSON.stringify</dfn>,
            <dfn>JSON.parse</dfn>, <dfn><code>Array</code></dfn>,
            <dfn><code>type</code></dfn> and the <dfn>[[\GetOwnProperty]]</dfn>
            operation are defined by [[!ECMA-262-2015]].
            <p>This document uses the format <em>object</em>@[[\slotname]] to
                mean the internal slot [[\slotname]] of the object
                <em>object</em>.</p>
            <p>The term <dfn>JSON-serializable object</dfn> used in this
                specification means an object that can be serialized to a string
                using <a>JSON.stringify</a> and later deserialized back to an
                object using <a>JSON.parse</a> with no loss of data.</p>
            <p>When instructed to <dfn>Trim</dfn>(<var>x</var>), a user agent
                MUST behave as if [[!ECMA-262-2015]]'s
                <code>String.prototype.trim()</code> function had been called on
                the string <var>x</var>.</p>
        </dd>
        <dt>DOM4</dt>
        <dd>The <code><dfn>Event</dfn></code> type and the terms <dfn>fire
            an event</dfn>, <dfn>dispatch flag</dfn>, <dfn>stop propagation
            flag</dfn>, and <dfn>stop immediate propagation flag</dfn> are
            defined by [[!DOM4]].
            <p><dfn>DOMException</dfn> and the following DOMException types
                from [[!DOM4]] are used:</p>
            <table>
                <tr>
                    <th>Type</th>
                    <th>Message (optional)</th>
                </tr>
                <tr>
                    <td><code><dfn>InvalidStateError</dfn></code></td>
                    <td>The object is in an invalid state</td>
                </tr>
                <tr>
                    <td><code><dfn>NotSupportedError</dfn></code></td>
                    <td>The payment method was not supported</td>
                </tr>
                <tr>
                    <td><code><dfn>SecurityError</dfn></code></td>
                    <td>The operation is only supported in a secure context</td>
                </tr>
            </table>
        </dd>
        <dt>WebIDL</dt>
        <dd>When this specification says to <dfn>throw</dfn> an error, the
            <a>user agent</a> must throw an error as described in [[!WEBIDL]].
            When this occurs in a sub-algorithm, this results in termination of
            execution of the sub-algorithm and all ancestor algorithms until
            one is reached that explicitly describes procedures for catching
            exceptions.</dd>
        <dt>Secure Contexts</dt>
        <dd>The term <dfn>secure context</dfn> is defined by the Secure
            Contexts specification [[!POWERFUL-FEATURES]].</dd>
        <dt>URL</dt>
        <dd>The <dfn>URL</dfn> concept and <dfn>URL parser</dfn> are
            defined in [[!WHATWG-URL]].</dd>
        <dt>Fetch</dt>
        <dd>The terms <dfn>Fetch</dfn>, <dfn>Request</dfn>, <dfn data-lt="body">Request Body</dfn>, <dfn data-lt="method">Request
            Method</dfn>, <dfn>Header List</dfn>, <dfn>Response</dfn>,
            <dfn>Context</dfn> and <dfn>Network Error</dfn> are defined in
            [[!FETCH]].</dd>
    </dl>
</section>
<section class="informative">
    <h2>Payment apps</h2>
    <p><dfn data-lt="payment apps|payment app">Payment apps</dfn> are
        applications that process payment requests and return payment responses.
        They could take the form of sophisticated Web apps (using the full stack of
        Web technologies such as HTML5, CSS and JavaScript), simple <a>ServiceWorkers</a>,
        interface-less Web services,  platform-specific native applications, built-in
        <a>user agent</a> components, browser extensions or even a combination of these.</p>
    <p>The <a>payment app</a> acts on behalf of the payer (or their
        chosen payment services provider) and performs any logic required
        for the chosen <a>payment method</a> to process the payment request.</p>
    <p>The specific processing required by the <a>payment app</a>,
        including the format of the payment request that the app accepts
        and the format of the reponse it returns, is defined by the
        <a>payment method specification</a> for the <a>payment
            method</a> that is used to process the transaction.</p>
    <section>
        <h3>Supported vs Enabled Payment Methods</h3>
        <p><a>Payment apps</a> support one or more <a>payment methods</a>.
            Support for a payment method implies that the app SHOULD be able to
            process a payment request that conforms to the rules defined in the
            <a>payment method specification</a> for that payment
            method and SHOULD be able to return an appropriate response.</p>
        <p>However, sometimes an app will be designed to support a specific
            payment method but the app will not have been configured with the
            appropriate <a>payment method data</a> (such as user credentials)
            to process payments using that payment method. In that case the
            <a>payment app</a> is said to <code>support</code> the payment
            method but that payment method is not <code>enabled</code>.</p>
        <p>For example, a <a>payment app</a> may be capable of processing a
            credit card payment by simply returning the card details in the
            payment response but unless the user has configured the payment app
            with the card details or is able to provide these at the time of
            processing that method is not <code>enabled</code>.</p>
        <p>If a payment app defines a payment method as <code>enabled</code>
            then it MUST be able to process any payment
            request that lists that payment method as supported and is
            formatted correctly according to the <a>payment method
            specification</a> for that payment method.</p>
        <p><a>User agents</a> should only consider <code>enabled</code>
            payment methods when evaluating if a <a>payment app</a> is
            appropriate to process a given payment request.</p>
    </section>
</section>
<section>
    <h2>Registering a payment app</h2>
    <p>In order to begin processing payment requests from the <a>user
        agent</a> a <a>payment app</a> must first be registered so that the
        <a>user agent</a> is aware of the set of <a>payment methods</a> the
        app has enabled and the URL of the app's HTTP API entry point.</p>
    <p class="note">The process of <a>payment app</a> registration is modeled on the
        process defined for <a>installing</a> an application via a
        <a>manifest</a>, as described in [[APPMANIFEST]]. In future payment
        apps may also be installed via web app manifests.</p>
    <section>
        <h3>The PaymentApp dictionary</h3>
<pre class="idl">
            dictionary PaymentApp {
                DOMString name;
                URLString start_url;
                sequence&lt;DOMString&gt; enabled_methods;
            };
</pre>
        <section>
            <h3>
                <code>name</code> member
            </h3>
            <p>
                The <dfn id="payment-app-name"><code>name</code> member</dfn> is a
                <a>string</a> that represents the name of the payment app as it
                is usually displayed to the user (e.g., among a list of other
                payment apps, or as a label for an icon).
            </p>
        </section>
        <section>
            <h3>
                <code>start_url</code> member
            </h3>
            <p>
                The <dfn id="payment-app-start-url"><code>start_url</code> member</dfn> is a <a>string</a> that
                represents the <dfn>start URL</dfn>, which is the <a>URL</a> that accepts
                payment request messages via HTTP POST.
            </p>
            <p>
                The <code><a>start_url</a></code> is the API entry point for the payment
                app and must have the same <a>origin</a> as the web application that attempts
                to register the payment app.
            </p>
            <p>
                The <code><a>start_url</a></code> is also the unique identifier for the payment app.
                If a payment app is already installed with the same <code><a>start_url</a></code>
                it will be replaced if a new payment app is registered with the same URL.
            </p>
        </section>
        <section>

            <h3><code>enabled_methods</code></h3>
            <p>
                The <dfn id="payment-app-enabled-methods">enabled_methods</dfn> member
                lists the <a>payment method identifers</a> of the <a>payment methods</a>
                that can be processed by the payment app.
            </p>
        </section>
    </section>
    <section>
        <h3>registerPaymentApp()</h3>
<pre class="idl">
            partial interface Navigator {
                readonly attribute PaymentsApi payments;
            };

            partial interface PaymentsApi {
                void registerPaymentApp (PaymentApp payment_app);
            };
</pre>
        <div class="issue" data-number="" title=
                "Should all payment related functions be rooted in navigator.payments?">
            The current shape of the <a>Payment Request API</a> makes it
            difficult to define the registration functions in a similar style.
            Perhaps a payment request should be instantiated via a factory
            method like
            <code>navigator.payments.createPaymentRequest</code>?</div>
        <p>The <code><dfn>registerPaymentApp</dfn></code> method can be
            used to register or update a <a>payment app</a> installation.</p>
        <p>The <dfn>steps for installing a payment app</dfn> are given by
            the following algorithm. The algorithm takes a <a>PaymentApp</a> argument
            (<var>payment_app</var>) as input.
            The algorithm, if successful, returns nothing; otherwise, it terminates
            prematurely and throws an exception.</p>
        <div class="issue" title="TODO: Define install algorithm">
        </div>
            <p>The following example shows how to register a payment app:</p>
<pre class="example highlight">
                try {
                    navigator.payments.registerPaymentApp(payment_app);
                    // Do any custom post-processing
                    // Example: Install ServiceWorker to handle offline payment requests
                }).catch(function(err) {
                  console.error("Uh oh, something bad happened", err.message);
                });

</pre></section>
    </section>
</section>
<section>
    <h2>Processing Payment Requests</h2>
    <p>When a <a>user agent</a> has completed the <a>payment app</a>
        selection algorithm as defined in the PaymentRequest API
        [[!PAYMENT-REQUEST-API]] it must pass the payment request to
        the <a>payment app</a> to be processed.</p>
    <p>The <a>user agent</a> does this by, converting the payment
        request into a JSON serialized object, executing an HTTP POST
        request against the <code>start_url</code> of the
        <a>payment app</a>.</p>
    <p>At a minimum the <a>user agent</a> MUST handle the following two
        responses from the <a>payment app</a>:</p>
    <ol>
        <li><p>
                An HTML response that MUST be rendered by the <a>user agent</a>.
            </p>
            <p class="issue" title="How should the browser render the payment app HTML?">
                When the browser gets HTML back from the payment app it must render this
                UI for the user to interact with the payment app. Should this be in an iframe,
                in a special modal dialogue or just a new tab? Is this an implementation
                detail?
            </p>
        </li>
        <li>A JSON serialized payment response which is converted by the
            <a>user agent</a> into a <a>PaymentResponse</a> object. The
            <a>Promise</a> that was returned to the payee website when calling
            <a><code>PaymentRequest.show</code></a> MUST resolve to this
            <a>PaymentResponse</a>.</li>
    </ol>
    <section>
        <h3>Converting the <a>PaymentRequest</a> into JSON.</h3>
        <p>Before the <a>PaymentRequest</a> can be submitted to the
            <a>payment app</a> it must be converted into a JSON serialized
            string.</p>
        <p>The <dfn>steps to convert the <code>PaymentRequest</code> to
            JSON</dfn> are given by the following algorithm. The algorithm
            takes a <a>PaymentRequest</a> (<var>request</var>) as input and
            returns a string.</p>
        <div class="issue" data-number="" title=
                "Need to define an algorithm for converting the PaymentRequest to JSON">
            <p>
                The algortihm for this conversion will depend on the outcome of
                discussions around the shape of the PaymentRequest API. This
                algorithm may also sit in the core messages spec.
            </p>
            <p>
                The fact that there are elements of this specification that can't be decided
                until the Payment Request API is decided is another indication that the two
                should be combined or have a normative dependancy.
            </p>
        </div>
    </section>
    <section>
        <h3>Sending the <a>Payment Request</a> to the <a>Payment
            App</a></h3>
        <p>The <dfn>steps to submit the payment request to the
            payment app</dfn> are given by the following algorithm:</p>
        <ol>
            <li>Let <var>payment request</var> be the string that is the
                outcome of the <a>steps to convert the <code>PaymentRequest</code>
                    to JSON</a>.</li>
            <li>Let <var>payment app</var> be the registered <a>payment app</a>
                selected by the user to process this <a>PaymentRequest</a>.
                <div class="issue" data-number="" title=
                        "What are the appriate fetch parameters for this request?">We
                    should get input form Web Platform and WebAppSec on how to best
                    construct this request.</div>
            </li>
            <li>Let <var>request</var> be a new [[!FETCH]] <a>request</a>,
                whose members are set to the following values:
                <table>
                    <tr>
                        <th>Member</th>
                        <th>Value</th>
                    </tr>
                    <tr>
                        <td><code><a>URL</a></code></td>
                        <td>The value of the <code>start_url</code> member of <var>payment
                            app</var></td>
                    </tr>
                    <tr>
                        <td><code><a>method</a></code></td>
                        <td>The value "<code>POST</code>"</td>
                    </tr>
                    <tr>
                        <td><code><a>header list</a></code></td>
                        <td>
                            <table>
                                <tr>
                                    <td><code>Accept</code></td>
                                    <td>text/html;application/json</td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    <tr>
                        <td><code><a>body</a></code></td>
                        <td>The value of <var>payment request</var></td>
                    </tr>
                </table>
            </li>
            <li>Await the result of performing a <a>fetch</a> with
                <var>request</var>, letting <var>response</var> be the result.</li>
            <li>If <var>response</var> is a <a>network error</a>, terminate
                this algorithm.</li>
            <li>
                <p>Switch on <var>response</var>'s <var>MIME type</var></p>
                <dl class="switch">
                    <dt>text/html</dt>
                    <dd>
                        <ol>
                            <li>Execute the <a>steps to render a web based payment app</a>
                                using <var>response</var> as input.</li>
                        </ol>
                    </dd>
                    <dt>application/json</dt>
                    <dd>
                        <ol>
                            <li style="list-style: none; display: inline">
                                <div class="issue" data-number="" title=
                                        "How do we signal that this JSON is a PaymentResponse?">Should the
                                    JSON encoded PaymentRequest and PaymentResponse be JSON-LD with an
                                    associated @context?</div>
                            </li>
                            <li>If <var>response</var>'s <var>body</var> is a JSON encoded
                                <a>PaymentResponse</a> execute the <a>steps to create a
                                    <code>PaymentResponse</code> from JSON</a> using the
                                <var>response</var>'s <var>body</var> as input.</li>
                            <li>Otherwise reject the <a>Promise</a> created during <a>PaymentRequest.show</a>
                             with an error.</li>
                        </ol>
                    </dd>
                </dl>
            </li>
        </ol>
    </section>
    <section>
        <h2>Launching the Payment App</h2>
        <p>Unless the selected payment app is built into the <a>user
            agent</a> or uses a proprietary mechanism for launching and
            interfacing with the <a>payment app</a>, the <a>user agent</a> MUST
            launch the <a>payment app</a> based upon the response it gets from
            submitting the <a>PaymentRequest</a>.</p>
        <p>The MIME Type and other signals are used to determine how the
            app is launched and what type of app is launched.</p>
        <section>
            <h3>Web Based Payment App with HTML interface</h3>
            <p>If the payment app is a web application with an HTML-based user
                interface then the response will have a <code>MIME Type</code> of
                <code>text/html</code>.</p>
            <p>If a <a>user agent</a> receives a response with a <code>MIME
                Type</code> of <code>text/html</code> it MUST assume that the
                response body is the HTML that must be rendered as the user
                interface of the <a>payment app</a>.</p>
            <p>The <a>user agent</a> MUST execute the <dfn>steps to render a
                web based payment app</dfn> as given by the following algorithm.
                The algorithm takes a [[!FETCH]] <a>Response</a>
                (<var>response</var>) as input:</p>
            <ol>
                <li>Create a new <a>top-level browsing context</a> in a new tab,
                    window or dialogue as <var>new context</var>.</li>
                <li>Render the <var>response</var> in the <var>new
                    context</var>.</li>
            </ol>
            <section>
                <h4>Accepting the PaymentResponse</h4>
<pre class="idl">
                    partial interface Navigator {
                        readonly attribute PaymentsApi payments;
                    };

                    partial interface PaymentsApi {
                        Promise&lt;boolean&gt; submitPaymentResponse (PaymentResponse response);
                    };


</pre>
                <p>The user will interact directly with web based <a>payment
                    apps</a> in the context created for this purpose
                    by the <a>user agent</a>.</p>
                <p>When the <a>payment app</a> is ready to do so, it must submit a
                    <a>PaymentResponse</a> to the <a>user agent</a> that can be
                    returned to the website that submitted the initial
                    <a>PaymentRequest</a>. It does this by calling
                    <code>submitPaymentResponse</code>.</p>
            </section>
        </section>
        <section>
            <h3>Autonomous Payment App services with no user interface</h3>
            <p>If the payment app is a web service that requires no user
                interface then the response must set the <code>Content-Type</code>
                header to the value <code>application/json</code> and the response
                body should be a JSON serialized payment response object.</p>
            <p>The <dfn>steps to create a <code>PaymentResponse</code> from
                JSON</dfn> are given in the following algorithm:</p>
            <div class="issue" data-number="" title=
                    "Need to define an algorithm for parsing a PaymentRequest object from JSON">
                This will likely sit in the core messages spec.</div>
        </section>
    </section>
    <section>
        <h2>Resolving the PaymentResponse Promise</h2>
        <p>The <a>user agent</a> must return a <a>PaymentResponse</a> to
            the website that originally initiated the <a>PaymentRequest</a>.
            The <dfn>steps for returning the <a>PaymentResponse</a></dfn> are
            given by the following algorithm.</p>
        <ol>
            <li>Let <var>response</var> be an empty
                <a>PaymentResponse</a>.</li>
            <li>Let <var>promise</var> be the <a>Promise</a> that was created
                by <a>PaymentRequest.show</a>.</li>
            <li>If a web based <a>payment app</a> called
                <code>submitPaymentResponse</code> then
                set <var>response</var> equal to the first parameter passed to
                that method.</li>
            <li>Otherwise, if the <a>steps to submit the
                <code>PaymentRequest</code> to the payment app</a> resulted in the
                return of a JSON encoded <a>PaymentResponse</a> then set
                <var>response</var> to the result of running the <a>steps to create
                    a <code>PaymentResponse</code> from JSON</a>.</li>
            <li>Resolve <var>promise</var> with <var>response</var>.</li>
        </ol>
    </section>
</section>
<p class="issue" data-number="55" title=
        "Add section on security considerations">The spec should indicate
    how data might be passed securely through the API using mechanisms
    such as field level encryption and message signing. While these may
    not be standardised a reference to the payment method
    specifications would be appropriate as well as some examples of how
    those Specifications might implement secure messaging.</p>
</body>
</html>
